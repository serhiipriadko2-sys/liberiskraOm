# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ 2FA —Å–∏—Å—Ç–µ–º—ã –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –ò—Å–∫—Ä–∞

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 06.11.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** Claude Code Security Agent  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç–∏–≤–Ω—ã–π

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ](#–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ-—Ä–µ–∑—é–º–µ)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 2FA —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-2fa-—Å–∏—Å—Ç–µ–º—ã)
3. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
4. [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞](#—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–∏-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
5. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-—ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π)
6. [–ü—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è](#–ø—Ä–æ—Ü–µ–¥—É—Ä—ã-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å-–∏-—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ)
8. [–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞—É–¥–∏—Ç](#–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥-–∏-–∞—É–¥–∏—Ç)
9. [–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π](#—É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ-–Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π)
10. [–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

---

## –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ

### –¶–µ–ª–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ 2FA

–ê–∫—Ç–∏–≤–∞—Ü–∏—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (2FA) –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –ò—Å–∫—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞:

- **–ü–æ–≤—ã—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é:** –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π GDPR, CCPA –∏ –¥—Ä—É–≥–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤
- **–ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ò—Å–∫—Ä—ã

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **TOTP –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ RFC 6238
- **QR-–∫–æ–¥ –º–æ–¥—É–ª—å:** –í–∏–∑—É–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- **Backup –∫–æ–¥—ã:** –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
- **Recovery –ø—Ä–æ—Ü–µ–¥—É—Ä—ã:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ‚àÜDŒ©Œõ:** –ü—Ä–æ—Ç–æ–∫–æ–ª –≤–∫–ª—é—á–∞–µ—Ç 2FA –≤ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ 2FA —Å–∏—Å—Ç–µ–º—ã

### –°—Ö–µ–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞ –ò—Å–∫—Ä–∞                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ –§—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–µ     ‚îÇ  ‚îÇ –•–∞–æ—Å –ú–∞–∫–∏       ‚îÇ  ‚îÇ –ú–µ—Ç–∞-‚àÜDŒ©Œõ    ‚îÇ ‚îÇ
‚îÇ  ‚îÇ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ     ‚îÇ  ‚îÇ (2FA —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)‚îÇ  ‚îÇ (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   2FA Core —Å–∏—Å—Ç–µ–º–∞                          ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ TOTP        ‚îÇ ‚îÇ Backup      ‚îÇ ‚îÇ Recovery    ‚îÇ ‚îÇ Security ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Generator   ‚îÇ ‚îÇ Codes       ‚îÇ ‚îÇ Manager     ‚îÇ ‚îÇ Logger   ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–ª–æ–∏                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ API Gateway ‚îÇ ‚îÇ Auth API    ‚îÇ ‚îÇ Database    ‚îÇ ‚îÇ Secrets  ‚îÇ ‚îÇ
‚îÇ  ‚îÇ (2FA Middleware)‚îÇ ‚îÇ Integration‚îÇ ‚îÇ Layer       ‚îÇ ‚îÇ Manager  ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü—Ä–æ—Ç–æ–∫–æ–ª ‚àÜDŒ©Œõ –≤ 2FA

–ö–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ 2FA —Å–∏—Å—Ç–µ–º—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ‚àÜDŒ©Œõ:

```json
{
  "‚àÜ": {
    "change_type": "2fa_setup_initiated",
    "timestamp": "2025-11-06T17:00:34Z",
    "user_id": "user_123",
    "action": "totp_registration"
  },
  "D": {
    "source": "2fa_frontend",
    "trace": "2fa_setup_session_abc123",
    "context": "web_authentication"
  },
  "Œ©": {
    "confidence": 0.95,
    "risk_assessment": "low",
    "verification_status": "pending"
  },
  "Œõ": {
    "intent": "enhance_security",
    "next_step": "qr_code_generation",
    "security_level": "enhanced"
  }
}
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Python:** 3.11+
- **–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏:** pyotp, qrcode, cryptography, passlib
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL 14+ / SQLite –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ:** OpenSSL 3.0+
- **–í—Ä–µ–º—è:** NTP —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–º–∞–∫—Å. –¥—Ä–µ–π—Ñ 30 —Å–µ–∫—É–Ω–¥)

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```text
pyotp>=2.9.0          # TOTP –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
qrcode[pil]>=7.4.2    # QR –∫–æ–¥—ã
cryptography>=41.0.7  # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
passlib>=1.7.4        # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
pydantic>=2.5.0       # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
sqlalchemy>=2.0.23    # ORM –¥–ª—è –ë–î
python-jose>=3.3.0    # JWT —Ç–æ–∫–µ–Ω—ã
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
2FA_ENCRYPTION_KEY=your_32_byte_encryption_key
2FA_JWT_SECRET=your_jwt_secret_key
2FA_DATABASE_URL=postgresql://user:pass@localhost/iskra_2fa
2FA_TIME_WINDOW=30     # –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
2FA_BACKUP_CODES_COUNT=10
2FA_MAX_FAILED_ATTEMPTS=5
2FA_LOCKOUT_DURATION=300  # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
```

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python -m venv venv_2fa
source venv_2fa/bin/activate  # Linux/Mac
# venv_2fa\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
pip install -r requirements_2fa.txt
```

### –®–∞–≥ 2: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```python
# scripts/init_2fa_db.py
from iskra_2fa.models import Base, engine
from iskra_2fa.database import create_tables

def setup_database():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 2FA –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    Base.metadata.create_all(bind=engine)
    create_tables()
    print("2FA database initialized successfully")

if __name__ == "__main__":
    setup_database()
```

### –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

```bash
# scripts/generate_keys.sh
#!/bin/bash

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è 2FA
python -c "
import secrets
key = secrets.token_bytes(32)
print('2FA_ENCRYPTION_KEY=' + key.hex())
"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Å–µ–∫—Ä–µ—Ç–∞
python -c "
import secrets
secret = secrets.token_urlsafe(32)
print('2FA_JWT_SECRET=' + secret)
"
```

### –®–∞–≥ 4: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã

```yaml
# config/2fa_config.yaml
security:
  encryption:
    algorithm: "AES-256-GCM"
    key_rotation_days: 90
    
  totp:
    window: 30  # seconds
    digits: 6
    algorithm: "SHA1"
    
  backup_codes:
    count: 10
    length: 8
    algorithm: "SHA256"
    
  lockout:
    max_attempts: 5
    lockout_duration: 300  # seconds
    progressive_delay: true

  recovery:
    methods: ["email", "sms", "admin"]
    trusted_devices: true
    recovery_email_timeout: 3600  # seconds

audit:
  log_level: "INFO"
  retention_days: 365
  sensitive_data_masking: true
  
database:
  url: "${2FA_DATABASE_URL}"
  pool_size: 10
  max_overflow: 20
  echo: false
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –§—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

2FA —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:

```python
# iskra_2fa/integration/fractal_logger.py
from iskra_2fa.fractal_logger import FractalLogger
import uuid

class TwoFAFractalLogger(FractalLogger):
    def log_2fa_event(self, event_type, user_id, details=None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ 2FA —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ ‚àÜDŒ©Œõ"""
        
        fractal_log = {
            "‚àÜ": {
                "change_type": f"2fa_{event_type}",
                "timestamp": datetime.utcnow().isoformat(),
                "user_id": user_id,
                "session_id": str(uuid.uuid4())
            },
            "D": {
                "source": "2fa_core",
                "trace": details.get("trace_id") if details else None,
                "context": "authentication",
                "risk_level": details.get("risk_level", "unknown") if details else "unknown"
            },
            "Œ©": {
                "confidence": details.get("confidence", 0.5) if details else 0.5,
                "verification_success": details.get("success", False) if details else False,
                "security_score": self.calculate_security_score(event_type, details)
            },
            "Œõ": {
                "intent": "authentication_enhancement",
                "next_step": self.get_next_step(event_type),
                "compliance_requirements": ["GDPR", "OWASP", "ISO27001"]
            }
        }
        
        self.log_fractal_event(fractal_log)
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –•–∞–æ—Å –ú–∞–∫–∏

–•–∞–æ—Å –ú–∞–∫–∏ –º–æ–∂–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å 2FA —Å–∏—Å—Ç–µ–º—ã:

```python
# iskra_2fa/chaos_maki_integration.py
class TwoFAChaosTesting:
    def __init__(self, chaos_maki_client):
        self.client = chaos_maki_client
        
    async def run_2fa_resilience_tests(self):
        """–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ 2FA"""
        
        tests = [
            {
                "name": "time_drift_test",
                "description": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ –¥—Ä–µ–π—Ñ—É –≤—Ä–µ–º–µ–Ω–∏",
                "action": "simulate_time_drift",
                "parameters": {"drift_seconds": 60}
            },
            {
                "name": "concurrent_attempts_test", 
                "description": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞",
                "action": "concurrent_auth_attempts",
                "parameters": {"count": 10, "interval": 1}
            },
            {
                "name": "brute_force_test",
                "description": "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∫ –ø–æ–¥–±–æ—Ä—É",
                "action": "brute_force_attack",
                "parameters": {"max_attempts": 100, "rate_limit": true}
            }
        ]
        
        results = []
        for test in tests:
            result = await self.client.run_chaos_experiment(test)
            results.append(result)
            
        return results
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ú–µ—Ç–∞-‚àÜDŒ©Œõ

–ú–µ—Ç–∞-‚àÜDŒ©Œõ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 2FA:

```python
# iskra_2fa/meta_delta_omega_integration.py
class TwoFAMetaAnalysis:
    def analyze_2fa_effectiveness(self, time_range_days=30):
        """–ê–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ 2FA —á–µ—Ä–µ–∑ –ú–µ—Ç–∞-‚àÜDŒ©Œõ"""
        
        analysis = {
            "fractal_dimension": self.calculate_fractal_dimension(),
            "security_metrics": {
                "successful_auth_rate": self.get_success_rate(),
                "failed_attempts_distribution": self.get_failure_distribution(),
                "user_adoption_rate": self.get_adoption_rate()
            },
            "recommendations": self.generate_recommendations(),
            "evolution_trajectory": self.predict_evolution()
        }
        
        return analysis
    
    def generate_security_recommendations(self):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        return [
            "–£–≤–µ–ª–∏—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤",
            "–î–æ–±–∞–≤–∏—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤", 
            "–í–Ω–µ–¥—Ä–∏—Ç—å adaptive authentication –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∏—Å–∫–æ–≤",
            "–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
        ]
```

---

## –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```python
# iskra_2fa/recovery/recovery_manager.py
from enum import Enum
from typing import List, Optional
import secrets
import hashlib

class RecoveryMethod(Enum):
    EMAIL = "email"
    SMS = "sms" 
    ADMIN = "admin"
    BACKUP_CODES = "backup_codes"
    TRUSTED_DEVICE = "trusted_device"

class RecoveryManager:
    def __init__(self, database, security_logger):
        self.db = database
        self.logger = security_logger
        self.max_recovery_attempts = 3
        self.cooldown_period = 3600  # 1 —á–∞—Å
        
    async def initiate_recovery(self, user_id: str, method: RecoveryMethod) -> dict:
        """–ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"""
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        recovery_token = secrets.token_urlsafe(32)
        token_hash = hashlib.sha256(recovery_token.encode()).hexdigest()
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
        await self.db.save_recovery_token(
            user_id=user_id,
            method=method,
            token_hash=token_hash,
            expires_at=datetime.utcnow() + timedelta(hours=1),
            max_attempts=self.max_recovery_attempts
        )
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        await self.log_recovery_event(
            event_type="recovery_initiated",
            user_id=user_id,
            method=method,
            token_id=token_hash[:8]  # –ß–∞—Å—Ç–∏—á–Ω—ã–π ID –¥–ª—è –ª–æ–≥–æ–≤
        )
        
        return {
            "recovery_token": recovery_token,
            "method": method,
            "expires_in": 3600,
            "instructions": self.get_recovery_instructions(method)
        }
    
    async def complete_recovery(self, user_id: str, token: str, new_2fa_secret: str) -> bool:
        """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –Ω–æ–≤–æ–≥–æ 2FA —Å–µ–∫—Ä–µ—Ç–∞"""
        
        token_hash = hashlib.sha256(token.encode()).hexdigest()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞
        recovery_data = await self.db.get_recovery_token(user_id, token_hash)
        if not recovery_data or recovery_data.is_expired():
            await self.log_recovery_event(
                event_type="recovery_failed_invalid_token",
                user_id=user_id
            )
            return False
            
        if recovery_data.attempts >= self.max_recovery_attempts:
            await self.log_recovery_event(
                event_type="recovery_failed_max_attempts",
                user_id=user_id
            )
            return False
        
        # –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ 2FA —Å–µ–∫—Ä–µ—Ç–∞
        await self.db.invalidate_2fa_secret(user_id)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞
        new_secret = pyotp.random_base32()
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ–∫—Ä–µ—Ç–∞
        await self.db.update_2fa_secret(user_id, new_secret)
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö backup –∫–æ–¥–æ–≤
        backup_codes = await self.generate_backup_codes(user_id)
        
        # –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        await self.db.invalidate_recovery_token(user_id, token_hash)
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        await self.log_recovery_event(
            event_type="recovery_successful",
            user_id=user_id,
            old_secret_invalidated=True,
            new_backup_codes_generated=len(backup_codes)
        )
        
        return True

    async def generate_backup_codes(self, user_id: str) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è backup –∫–æ–¥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        codes = []
        for _ in range(10):  # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 10 –∫–æ–¥–æ–≤
            code = ''.join(secrets.choice('0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ') for _ in range(8))
            code_hash = hashlib.sha256(code.encode()).hexdigest()
            codes.append(code)
            
        await self.db.save_backup_codes(user_id, code_hashes=[code_hash for code in codes])
        return codes
```

### –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

```python
# iskra_2fa/recovery/admin_recovery.py
class AdminRecoveryManager:
    def __init__(self, admin_authenticator, security_logger):
        self.admin_auth = admin_authenticator
        self.logger = security_logger
        
    @require_admin_role("security_admin")
    async def admin_reset_2fa(self, user_id: str, admin_id: str, reason: str) -> dict:
        """–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–±—Ä–æ—Å 2FA (—Ç—Ä–µ–±—É–µ—Ç –∞—É–¥–∏—Ç–∞)"""
        
        # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        admin_verified = await self.admin_auth.verify_admin(admin_id)
        if not admin_verified:
            raise SecurityException("Invalid administrator credentials")
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        service_token = secrets.token_urlsafe(64)
        
        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–º —Å–±—Ä–æ—Å–µ
        await self.log_admin_action(
            admin_id=admin_id,
            action="2fa_reset",
            target_user=user_id,
            reason=reason,
            service_token=service_token
        )
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞–ª–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        portal_url = await self.create_recovery_portal(
            user_id=user_id,
            service_token=service_token,
            admin_id=admin_id,
            reason=reason
        )
        
        return {
            "recovery_portal": portal_url,
            "service_token": service_token,
            "expires_in": 7200,  # 2 —á–∞—Å–∞
            "requires_user_verification": True
        }
    
    @require_admin_role("security_admin") 
    async def view_recovery_log(self, user_id: str, time_range_days: int = 30) -> List[dict]:
        """–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        recovery_logs = await self.db.get_recovery_logs(
            user_id=user_id,
            days=time_range_days
        )
        
        # –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        for log in recovery_logs:
            if "token_hash" in log:
                log["token_hash"] = log["token_hash"][:8] + "..."
                
        return recovery_logs
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

### –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```python
# iskra_2fa/security/encryption.py
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
import base64
import os

class TwoFAEncryption:
    def __init__(self, master_key: str):
        self.master_key = master_key.encode()
        self.fernet = self._create_fernet()
        
    def _create_fernet(self) -> Fernet:
        """–°–æ–∑–¥–∞–Ω–∏–µ Fernet –æ–±—ä–µ–∫—Ç–∞ —Å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º –∫–ª—é—á–æ–º"""
        salt = os.urandom(16)
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=salt,
            iterations=100000,
        )
        key = base64.urlsafe_b64encode(kdf.derive(self.master_key))
        return Fernet(key)
    
    def encrypt_secret(self, secret: str) -> str:
        """–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ TOTP —Å–µ–∫—Ä–µ—Ç–∞"""
        encrypted = self.fernet.encrypt(secret.encode())
        return base64.urlsafe_b64encode(encrypted).decode()
    
    def decrypt_secret(self, encrypted_secret: str) -> str:
        """–î–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ TOTP —Å–µ–∫—Ä–µ—Ç–∞"""
        encrypted_data = base64.urlsafe_b64decode(encrypted_secret.encode())
        decrypted = self.fernet.decrypt(encrypted_data)
        return decrypted.decode()
```

### –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ GDPR

```python
# iskra_2fa/compliance/gdpr_compliance.py
class GDPRCompliance:
    def __init__(self, database, data_processor):
        self.db = database
        self.processor = data_processor
        
    async def handle_data_subject_request(self, request_type: str, user_id: str, request_data: dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å—É–±—ä–µ–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö GDPR"""
        
        if request_type == "access":
            return await self.export_user_data(user_id)
        elif request_type == "rectification":
            return await self.correct_user_data(user_id, request_data)
        elif request_type == "erasure":
            return await self.delete_user_data(user_id)
        elif request_type == "portability":
            return await self.export_portable_data(user_id)
        else:
            raise ValueError(f"Unknown GDPR request type: {request_type}")
    
    async def export_user_data(self, user_id: str) -> dict:
        """–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ü—Ä–∞–≤–æ –Ω–∞ –¥–æ—Å—Ç—É–ø)"""
        
        user_data = await self.db.get_user_data(user_id)
        twofa_data = await self.db.get_2fa_data(user_id)
        
        export_data = {
            "export_date": datetime.utcnow().isoformat(),
            "user_profile": {
                "user_id": user_data.user_id,
                "created_at": user_data.created_at.isoformat(),
                "last_login": user_data.last_login.isoformat() if user_data.last_login else None
            },
            "2fa_configuration": {
                "enabled": twofa_data.enabled if twofa_data else False,
                "setup_date": twofa_data.setup_date.isoformat() if twofa_data and twofa_data.setup_date else None,
                "backup_codes_remaining": twofa_data.backup_codes_count if twofa_data else 0,
                "recovery_methods": twofa_data.recovery_methods if twofa_data else []
            },
            "security_events": await self.get_security_events(user_id, days=90)
        }
        
        return export_data
    
    async def delete_user_data(self, user_id: str) -> dict:
        """–£–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ü—Ä–∞–≤–æ –Ω–∞ –∑–∞–±–≤–µ–Ω–∏–µ)"""
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ GDPR –∑–∞–ø—Ä–æ—Å–∞
        await self.log_gdpr_request(
            user_id=user_id,
            request_type="erasure",
            timestamp=datetime.utcnow()
        )
        
        # –£–¥–∞–ª–µ–Ω–∏–µ 2FA –¥–∞–Ω–Ω—ã—Ö
        await self.db.delete_2fa_data(user_id)
        
        # –ê–Ω–æ–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π
        await self.db.anonymize_user_data(user_id)
        
        # –£–¥–∞–ª–µ–Ω–∏–µ backup –∫–æ–¥–æ–≤
        await self.db.delete_backup_codes(user_id)
        
        # –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è)
        await self.db.delete_security_logs(user_id, older_than_days=30)
        
        return {
            "status": "completed",
            "deleted_data_types": [
                "2fa_secrets",
                "backup_codes", 
                "security_logs",
                "recovery_tokens"
            ],
            "anonymized_data": ["user_profile", "audit_trail"]
        }
```

### OWASP —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

```python
# iskra_2fa/security/owasp_compliance.py
class OWASPSecurityControls:
    def __init__(self):
        self.rate_limiter = RateLimiter()
        self.input_validator = InputValidator()
        self.audit_logger = AuditLogger()
        
    async def validate_2fa_input(self, input_data: dict) -> ValidationResult:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ OWASP"""
        
        validation_rules = {
            "user_id": {"type": "string", "min_length": 1, "max_length": 100, "pattern": r"^[a-zA-Z0-9_-]+$"},
            "totp_code": {"type": "string", "pattern": r"^\d{6}$"},
            "backup_code": {"type": "string", "pattern": r"^[A-Z0-9]{8}$"}
        }
        
        try:
            validated_data = self.input_validator.validate(input_data, validation_rules)
            return ValidationResult(success=True, data=validated_data)
        except ValidationError as e:
            await self.audit_logger.log_security_event(
                event_type="input_validation_failed",
                details={"validation_error": str(e), "input_keys": list(input_data.keys())}
            )
            return ValidationResult(success=False, error=str(e))
    
    async def check_brute_force_protection(self, user_id: str, ip_address: str) -> bool:
        """–ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–±–æ—Ä–∞ –ø–∞—Ä–æ–ª–µ–π"""
        
        failed_attempts = await self.get_failed_attempts(user_id, ip_address, time_window=300)
        
        if failed_attempts >= 5:
            await self.initiate_account_lockout(user_id, ip_address, duration=1800)  # 30 –º–∏–Ω—É—Ç
            return False
            
        return True
    
    async def implement_defense_in_depth(self, user_id: str, action: str) -> SecurityChecklist:
        """–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π –∑–∞—â–∏—Ç—ã"""
        
        checklist = SecurityChecklist()
        
        # –£—Ä–æ–≤–µ–Ω—å 1: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
        checklist.add_check("user_authentication", await self.verify_user_identity(user_id))
        
        # –£—Ä–æ–≤–µ–Ω—å 2: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        checklist.add_check("authorization", await self.verify_permissions(user_id, action))
        
        # –£—Ä–æ–≤–µ–Ω—å 3: –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        checklist.add_check("input_validation", await self.validate_secure_input(user_id, action))
        
        # –£—Ä–æ–≤–µ–Ω—å 4: –ê—É–¥–∏—Ç
        checklist.add_check("audit_logging", await self.ensure_audit_logging(user_id, action))
        
        # –£—Ä–æ–≤–µ–Ω—å 5: –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
        checklist.add_check("encryption", await self.verify_encryption(user_id))
        
        return checklist
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞—É–¥–∏—Ç

### –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

```python
# iskra_2fa/monitoring/security_monitor.py
import structlog
from datetime import datetime, timedelta

class TwoFASecurityMonitor:
    def __init__(self, database, alert_manager):
        self.db = database
        self.alert_manager = alert_manager
        self.logger = structlog.get_logger("2fa.security")
        
    async def monitor_authentication_patterns(self):
        """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        
        # –ê–Ω–∞–ª–∏–∑ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
        auth_patterns = await self.db.get_authentication_patterns(
            time_range=timedelta(hours=24)
        )
        
        # –î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π
        anomalies = await self.detect_auth_anomalies(auth_patterns)
        
        for anomaly in anomalies:
            await self.handle_security_anomaly(anomaly)
    
    async def detect_auth_anomalies(self, patterns: List[AuthPattern]) -> List[SecurityAnomaly]:
        """–î–µ—Ç–µ–∫—Ü–∏—è –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        
        anomalies = []
        
        # –ê–Ω–æ–º–∞–ª–∏—è 1: –ù–µ–æ–±—ã—á–Ω–æ–µ –≤—Ä–µ–º—è –≤—Ö–æ–¥–∞
        unusual_time_threshold = 3  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π
        for pattern in patterns:
            hour = pattern.timestamp.hour
            if not self.is_normal_business_hour(hour):
                if self.is_statistical_outlier(hour, pattern.user_id, unusual_time_threshold):
                    anomalies.append(SecurityAnomaly(
                        type="unusual_login_time",
                        user_id=pattern.user_id,
                        timestamp=pattern.timestamp,
                        severity="medium",
                        details={"login_hour": hour, "z_score": self.calculate_z_score(hour, pattern.user_id)}
                    ))
        
        # –ê–Ω–æ–º–∞–ª–∏—è 2: –ì–µ–æ–ª–æ–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∞–Ω–æ–º–∞–ª–∏—è
        geo_anomalies = await self.detect_geo_anomalies(patterns)
        anomalies.extend(geo_anomalies)
        
        # –ê–Ω–æ–º–∞–ª–∏—è 3: –ß–∞—Å—Ç—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
        failure_anomalies = await self.detect_failure_patterns(patterns)
        anomalies.extend(failure_anomalies)
        
        return anomalies
    
    async def handle_security_anomaly(self, anomaly: SecurityAnomaly):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        
        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏
        await self.logger.awarning(
            "Security anomaly detected",
            anomaly_type=anomaly.type,
            user_id=anomaly.user_id,
            severity=anomaly.severity,
            timestamp=anomaly.timestamp.isoformat()
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–ª–µ—Ä—Ç–∞
        if anomaly.severity in ["high", "critical"]:
            await self.alert_manager.send_security_alert(anomaly)
        
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–Ω–æ–º–∞–ª–∏–∏
        if anomaly.type == "excessive_failures":
            await self.initiate_account_monitoring(anomaly.user_id, duration=timedelta(hours=2))
        elif anomaly.type == "geo_anomaly":
            await self.send_geo_alert_notification(anomaly.user_id)
    
    async def generate_security_report(self, time_range_days: int = 30) -> dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ 2FA"""
        
        end_date = datetime.utcnow()
        start_date = end_date - timedelta(days=time_range_days)
        
        # –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
        total_auths = await self.db.count_authentication_attempts(start_date, end_date)
        successful_auths = await self.db.count_successful_auths(start_date, end_date)
        failed_auths = await self.db.count_failed_auths(start_date, end_date)
        
        # 2FA adoption metrics
        users_with_2fa = await self.db.count_users_with_2fa_enabled()
        total_users = await self.db.count_total_users()
        adoption_rate = (users_with_2fa / total_users) * 100 if total_users > 0 else 0
        
        # Security incidents
        security_incidents = await self.db.get_security_incidents(start_date, end_date)
        
        # Backup code usage
        backup_code_usage = await self.db.get_backup_code_usage_stats(start_date, end_date)
        
        report = {
            "report_period": {
                "start_date": start_date.isoformat(),
                "end_date": end_date.isoformat(),
                "days": time_range_days
            },
            "authentication_metrics": {
                "total_attempts": total_auths,
                "successful_attempts": successful_auths,
                "failed_attempts": failed_auths,
                "success_rate": (successful_auths / total_auths) * 100 if total_auths > 0 else 0
            },
            "2fa_adoption": {
                "users_with_2fa": users_with_2fa,
                "total_users": total_users,
                "adoption_rate_percent": round(adoption_rate, 2)
            },
            "security_incidents": {
                "total_incidents": len(security_incidents),
                "by_severity": self.group_incidents_by_severity(security_incidents),
                "by_type": self.group_incidents_by_type(security_incidents)
            },
            "backup_codes": backup_code_usage,
            "recommendations": await self.generate_security_recommendations(time_range_days)
        }
        
        return report
```

### –î–∞—à–±–æ—Ä–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```python
# iskra_2fa/dashboard/monitoring_dashboard.py
from datetime import datetime, timedelta
import json

class TwoFADashboard:
    def __init__(self, database):
        self.db = database
        
    async def get_real_time_metrics(self) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"""
        
        now = datetime.utcnow()
        last_hour = now - timedelta(hours=1)
        last_day = now - timedelta(days=1)
        
        metrics = {
            "timestamp": now.isoformat(),
            "active_sessions": await self.db.count_active_sessions(),
            "failed_attempts_last_hour": await self.db.count_failed_attempts(last_hour, now),
            "successful_auths_last_hour": await self.db.count_successful_auths(last_hour, now),
            "locked_accounts": await self.db.count_locked_accounts(),
            "2fa_setup_in_progress": await self.db.count_pending_2fa_setups(),
            "system_health": await self.get_system_health_status()
        }
        
        return metrics
    
    async def get_security_trends(self, days: int = 7) -> dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
        
        trends = []
        for i in range(days):
            date = datetime.utcnow() - timedelta(days=i)
            start_of_day = date.replace(hour=0, minute=0, second=0, microsecond=0)
            end_of_day = start_of_day + timedelta(days=1)
            
            day_metrics = {
                "date": start_of_day.date().isoformat(),
                "auth_attempts": await self.db.count_authentication_attempts(start_of_day, end_of_day),
                "successful_auths": await self.db.count_successful_auths(start_of_day, end_of_day),
                "failed_attempts": await self.db.count_failed_auths(start_of_day, end_of_day),
                "backup_codes_used": await self.db.count_backup_code_usage(start_of_day, end_of_day),
                "security_incidents": await self.db.count_security_incidents(start_of_day, end_of_day)
            }
            
            trends.append(day_metrics)
        
        return {
            "period_days": days,
            "daily_trends": list(reversed(trends)),
            "summary": await self.calculate_trends_summary(trends)
        }
```

---

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–µ–π

### –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### –ü—Ä–æ–±–ª–µ–º–∞ 1: TOTP –∫–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ö–æ–¥—ã –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –°–æ–æ–±—â–µ–Ω–∏–µ "Invalid token" –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –≤–≤–æ–¥–µ

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```python
# scripts/diagnose_totp.py
import pyotp
import time
from datetime import datetime

def diagnose_totp_issue(secret: str, user_provided_code: str):
    """–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å TOTP"""
    
    totp = pyotp.TOTP(secret)
    current_time = int(time.time())
    
    print(f"Current time: {datetime.fromtimestamp(current_time)}")
    print(f"Current code: {totp.at(current_time)}")
    print(f"Previous code: {totp.at(current_time - 30)}")
    print(f"Next code: {totp.at(current_time + 30)}")
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω
    for offset in range(-2, 3):
        check_time = current_time + (offset * 30)
        expected_code = totp.at(check_time)
        is_valid = expected_code == user_provided_code
        
        print(f"Time offset {offset}: {datetime.fromtimestamp(check_time)} -> {expected_code} {'‚úì' if is_valid else '‚úó'}")
```

**–†–µ—à–µ–Ω–∏—è:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Ä–µ–º—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
2. **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–∫–Ω–∞:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å window=2 –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π TOTP —Å–µ–∫—Ä–µ—Ç

#### –ü—Ä–æ–±–ª–µ–º–∞ 2: QR –∫–æ–¥ –Ω–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç—Å—è

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```python
# scripts/verify_qr_code.py
import pyotp
import qrcode
from PIL import Image

def test_qr_code_generation(secret: str, account_name: str, issuer: str):
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞"""
    
    totp = pyotp.TOTP(secret)
    provisioning_uri = totp.provisioning_uri(
        name=account_name,
        issuer_name=issuer
    )
    
    print(f"Provisioning URI: {provisioning_uri}")
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ QR –∫–æ–¥–∞
    qr = qrcode.QRCode(version=1, box_size=10, border=4)
    qr.add_data(provisioning_uri)
    qr.make(fit=True)
    
    img = qr.make_image(fill_color="black", back_color="white")
    img.save("test_qr_code.png")
    
    print("QR code saved to test_qr_code.png")
```

**–†–µ—à–µ–Ω–∏—è:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UTF-8 –¥–ª—è account_name –∏ issuer
2. **–§–æ—Ä–º–∞—Ç URI:** –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ provisioning URI
3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ —Å–µ–∫—Ä–µ—Ç–∞

#### –ü—Ä–æ–±–ª–µ–º–∞ 3: Backup –∫–æ–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```python
# scripts/verify_backup_codes.py
import hashlib
import secrets

def verify_backup_code_stored_vs_provided(stored_hash: str, provided_code: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è backup –∫–æ–¥–∞"""
    
    # –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
    provided_hash = hashlib.sha256(provided_code.encode()).hexdigest()
    
    # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ö–µ—à–µ–º
    return provided_hash == stored_hash

def generate_test_backup_codes(count: int = 10) -> list:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö backup –∫–æ–¥–æ–≤"""
    codes = []
    for _ in range(count):
        code = ''.join(secrets.choice('0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ') for _ in range(8))
        codes.append(code)
    return codes
```

**–†–µ—à–µ–Ω–∏—è:**
1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞:** Backup –∫–æ–¥—ã –º–æ–≥—É—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–æ–¥–æ–≤:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞–±–æ—Ä backup –∫–æ–¥–æ–≤
3. **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å email –∏–ª–∏ SMS –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞

```python
# iskra_2fa/debug/debug_tools.py
import logging
import structlog
from datetime import datetime

class TwoFADebugger:
    def __init__(self):
        self.logger = structlog.get_logger("2fa.debug")
        
    async def log_authentication_attempt(self, user_id: str, method: str, success: bool, details: dict):
        """–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
        
        log_entry = {
            "timestamp": datetime.utcnow().isoformat(),
            "event_type": "authentication_attempt",
            "user_id": user_id,
            "method": method,
            "success": success,
            "details": details,
            "context": {
                "user_agent": details.get("user_agent"),
                "ip_address": details.get("ip_address"),
                "session_id": details.get("session_id")
            }
        }
        
        if success:
            self.logger.info("2FA authentication successful", **log_entry)
        else:
            self.logger.warning("2FA authentication failed", **log_entry)
    
    async def enable_verbose_logging(self, user_id: str, duration_minutes: int = 30):
        """–í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"""
        
        # –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π —Å–µ—Å—Å–∏–∏ –æ—Ç–ª–∞–¥–∫–∏
        debug_session_id = f"debug_{user_id}_{int(datetime.utcnow().timestamp())}"
        
        await self.logger.info(
            "Verbose debugging enabled",
            debug_session=debug_session_id,
            user_id=user_id,
            duration_minutes=duration_minutes,
            expires_at=(datetime.utcnow() + timedelta(minutes=duration_minutes)).isoformat()
        )
        
        return debug_session_id
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ A: –ü–æ–ª–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

#### 1. –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª

```yaml
# config/2fa_complete_config.yaml
version: "1.0"
environment: "production"

security:
  encryption:
    algorithm: "AES-256-GCM"
    key_rotation_days: 90
    master_key_source: "environment"
    
  totp:
    window: 30  # seconds (–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–∏)
    digits: 6
    algorithm: "SHA1"
    issuer: "–ò—Å–∫—Ä–∞ –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞"
    
  backup_codes:
    count: 10
    length: 8
    algorithm: "SHA256"
    one_time_use: true
    
  lockout:
    max_attempts: 5
    lockout_duration: 300  # seconds
    progressive_delay: true
    ban_threshold: 10
    ban_duration: 3600  # 1 hour
    
  recovery:
    methods: ["email", "sms", "admin"]
    trusted_devices: true
    recovery_email_timeout: 3600
    admin_approval_required: false
    
  audit:
    log_level: "INFO"
    retention_days: 365
    sensitive_data_masking: true
    compliance_logging: true

database:
  url: "${2FA_DATABASE_URL}"
  pool_size: 10
  max_overflow: 20
  echo: false
  ssl_mode: "require"
  
api:
  rate_limiting:
    enabled: true
    requests_per_minute: 60
    burst_size: 10
    
  cors:
    allowed_origins: ["https://iskra.ai", "https://app.iskra.ai"]
    allowed_methods: ["GET", "POST", "PUT", "DELETE"]
    allowed_headers: ["Content-Type", "Authorization", "X-Requested-With"]
    
monitoring:
  metrics_enabled: true
  prometheus_port: 9090
  health_check_interval: 30
  alert_webhook: "${ALERT_WEBHOOK_URL}"

notifications:
  email:
    enabled: true
    smtp_server: "${SMTP_SERVER}"
    smtp_port: 587
    username: "${SMTP_USERNAME}"
    password: "${SMTP_PASSWORD}"
    
  sms:
    enabled: false
    provider: "twilio"
    account_sid: "${TWILIO_ACCOUNT_SID}"
    auth_token: "${TWILIO_AUTH_TOKEN}"
    
  slack:
    enabled: true
    webhook_url: "${SLACK_WEBHOOK_URL}"
    channel: "#security-alerts"

compliance:
  gdpr:
    enabled: true
    data_retention_days: 2555  # 7 years
    right_to_erasure: true
    data_portability: true
    
  hipaa:
    enabled: false
    audit_trail: true
    access_controls: true
    
  iso27001:
    enabled: true
    risk_assessment: true
    incident_response: true
```

#### 2. Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

```dockerfile
# Dockerfile.2fa
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
RUN groupadd -r iskra2fa && useradd -r -g iskra2fa iskra2fa

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements_2fa.txt /app/
WORKDIR /app
RUN pip install --no-cache-dir -r requirements_2fa.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
COPY . /app/
RUN chown -R iskra2fa:iskra2fa /app

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
USER iskra2fa

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1

# –ü–æ—Ä—Ç
EXPOSE 8000

# –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["python", "-m", "iskra_2fa.main"]
```

#### 3. Docker Compose

```yaml
# docker-compose.2fa.yml
version: '3.8'

services:
  2fa_api:
    build:
      context: .
      dockerfile: Dockerfile.2fa
    ports:
      - "8000:8000"
    environment:
      - 2FA_DATABASE_URL=postgresql://iskra2fa:password@postgres:5432/iskra_2fa
      - 2FA_ENCRYPTION_KEY=${2FA_ENCRYPTION_KEY}
      - 2FA_JWT_SECRET=${2FA_JWT_SECRET}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_DB=iskra_2fa
      - POSTGRES_USER=iskra2fa
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init_2fa_db.sql:/docker-entrypoint-initdb.d/init.sql
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    
  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/2fa.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl/certs
    depends_on:
      - 2fa_api
    restart: unless-stopped

volumes:
  postgres_data:
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ B: API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

#### OpenAPI —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

```yaml
# docs/openapi_2fa.yaml
openapi: 3.0.3
info:
  title: –ò—Å–∫—Ä–∞ 2FA API
  description: API –¥–ª—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –ò—Å–∫—Ä–∞
  version: 1.0.0
  contact:
    name: –ö–æ–º–∞–Ω–¥–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ò—Å–∫—Ä—ã
    email: security@iskra.ai

servers:
  - url: https://api.iskra.ai/v1/2fa
    description: Production server
  - url: https://staging-api.iskra.ai/v1/2fa
    description: Staging server

security:
  - BearerAuth: []
  - ApiKeyAuth: []

paths:
  /setup/initiate:
    post:
      summary: –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA
      tags: [Setup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                  description: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                method:
                  type: string
                  enum: [totp, sms, email]
                  description: –ú–µ—Ç–æ–¥ 2FA
              required: [user_id, method]
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞—Ü–∏—è
          content:
            application/json:
              schema:
                type: object
                properties:
                  setup_id:
                    type: string
                    description: ID —Å–µ—Å—Å–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                  qr_code_url:
                    type: string
                    description: URL –¥–ª—è QR –∫–æ–¥–∞
                  secret:
                    type: string
                    description: TOTP —Å–µ–∫—Ä–µ—Ç
                  backup_codes:
                    type: array
                    items:
                      type: string
                    description: –°–ø–∏—Å–æ–∫ backup –∫–æ–¥–æ–≤
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /verify/setup:
    post:
      summary: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA
      tags: [Setup]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                setup_id:
                  type: string
                totp_code:
                  type: string
                  pattern: '^\d{6}$'
              required: [setup_id, totp_code]
      responses:
        '200':
          description: 2FA —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        '400':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥
        '401':
          $ref: '#/components/responses/Unauthorized'

  /authenticate:
    post:
      summary: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å 2FA
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                totp_code:
                  type: string
                  pattern: '^\d{6}$'
                backup_code:
                  type: string
                  pattern: '^[A-Z0-9]{8}$'
              oneOf:
                - required: [user_id, totp_code]
                - required: [user_id, backup_code]
      responses:
        '200':
          description: –£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                  refresh_token:
                    type: string
                  expires_in:
                    type: integer
                    description: –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                  user_info:
                    type: object
        '401':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
        '423':
          description: –ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

  /recovery/initiate:
    post:
      summary: –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
      tags: [Recovery]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                method:
                  type: string
                  enum: [email, sms, admin]
                email:
                  type: string
                  format: email
                  description: Email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–µ—Å–ª–∏ method=email)
              required: [user_id, method]
      responses:
        '200':
          description: –ó–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        '404':
          description: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω

  /recovery/complete:
    post:
      summary: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
      tags: [Recovery]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                recovery_token:
                  type: string
                new_totp_secret:
                  type: string
              required: [recovery_token, new_totp_secret]
      responses:
        '200':
          description: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ
        '400':
          description: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      
  responses:
    BadRequest:
      description: –ù–µ–≤–µ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Invalid request data"
              details:
                type: object
                
    Unauthorized:
      description: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Authentication required"
              
    Forbidden:
      description: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: "Insufficient permissions"

  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time
        twofa_enabled:
          type: boolean
          description: –í–∫–ª—é—á–µ–Ω –ª–∏ 2FA
        
    AuthenticationResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        expires_in:
          type: integer
        token_type:
          type: string
          example: "Bearer"
        user_info:
          $ref: '#/components/schemas/User'
```

### –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ C: –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### 1. –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TOTP

```python
# examples/basic_totp_usage.py
import pyotp
import qrcode
from iskra_2fa.core import TOTPManager

async def setup_totp_for_user(user_id: str, email: str):
    """–ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ TOTP –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ TOTP
    totp_manager = TOTPManager()
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞
    secret = totp_manager.generate_secret()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ TOTP –æ–±—ä–µ–∫—Ç–∞
    totp = pyotp.TOTP(secret)
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è provisioning URI
    provisioning_uri = totp.provisioning_uri(
        name=email,
        issuer_name="–ò—Å–∫—Ä–∞ –≠–∫–æ—Å–∏—Å—Ç–µ–º–∞"
    )
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
    qr = qrcode.QRCode(version=1, box_size=10, border=4)
    qr.add_data(provisioning_uri)
    qr.make(fit=True)
    
    img = qr.make_image(fill_color="black", back_color="white")
    img.save(f"qr_code_{user_id}.png")
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –≤ –ë–î
    await totp_manager.save_secret(user_id, secret)
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è backup –∫–æ–¥–æ–≤
    backup_codes = await totp_manager.generate_backup_codes(user_id)
    
    return {
        "secret": secret,
        "qr_code_url": f"qr_code_{user_id}.png",
        "backup_codes": backup_codes,
        "provisioning_uri": provisioning_uri
    }

async def verify_totp_code(user_id: str, code: str):
    """–ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ TOTP –∫–æ–¥–∞"""
    
    totp_manager = TOTPManager()
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    secret = await totp_manager.get_secret(user_id)
    if not secret:
        return {"valid": False, "error": "2FA –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"}
    
    # –°–æ–∑–¥–∞–Ω–∏–µ TOTP –æ–±—ä–µ–∫—Ç–∞
    totp = pyotp.TOTP(secret)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
    is_valid = totp.verify(code, valid_window=1)
    
    return {"valid": is_valid}
```

#### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–º

```python
# examples/flask_integration.py
from flask import Flask, request, jsonify
from iskra_2fa.integrations.flask import TwoFAFlask
from iskra_2fa.core import TOTPManager

app = Flask(__name__)
twofa = TwoFAFlask(app)

@app.route('/api/login', methods=['POST'])
@twofa.require_2fa(optional=True)  # 2FA –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
def login():
    """–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 2FA"""
    
    data = request.get_json()
    user_id = data.get('user_id')
    password = data.get('password')
    totp_code = data.get('totp_code')
    
    # –ë–∞–∑–æ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
    if not authenticate_user(user_id, password):
        return jsonify({"error": "–ù–µ–≤–µ—Ä–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"}), 401
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ 2FA –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω
    if twofa.is_enabled(user_id):
        if not totp_code:
            return jsonify({"error": "–¢—Ä–µ–±—É–µ—Ç—Å—è 2FA –∫–æ–¥", "2fa_required": True}), 401
        
        if not twofa.verify_code(user_id, totp_code):
            return jsonify({"error": "–ù–µ–≤–µ—Ä–Ω—ã–π 2FA –∫–æ–¥"}), 401
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞
    access_token = generate_jwt_token(user_id)
    
    return jsonify({
        "access_token": access_token,
        "user_id": user_id,
        "2fa_enabled": twofa.is_enabled(user_id)
    })

@app.route('/api/2fa/setup', methods=['POST'])
@twofa.require_auth
def setup_2fa():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    
    user_id = request.user.id
    result = twofa.setup_totp(user_id, request.user.email)
    
    return jsonify(result)

@app.route('/api/2fa/verify', methods=['POST'])
@twofa.require_auth
def verify_2fa_setup():
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA"""
    
    user_id = request.user.id
    totp_code = request.json.get('totp_code')
    
    success = twofa.verify_setup(user_id, totp_code)
    if success:
        return jsonify({"message": "2FA —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω"})
    else:
        return jsonify({"error": "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"}), 400
```

#### 3. –ö–ª–∏–µ–Ω—Ç—Å–∫–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```javascript
// examples/totp_client.js
class TwoFAController {
    constructor(apiBaseUrl) {
        this.apiBaseUrl = apiBaseUrl;
    }
    
    async setup2FA(userId) {
        try {
            // –ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–Ω–∏—Ü–∏–∞—Ü–∏—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            const response = await fetch(`${this.apiBaseUrl}/2fa/setup/initiate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.getAuthToken()}`
                },
                body: JSON.stringify({
                    user_id: userId,
                    method: 'totp'
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                return {
                    success: true,
                    data: data
                };
            } else {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA');
            }
        } catch (error) {
            console.error('2FA setup error:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    async verify2FASetup(setupId, totpCode) {
        try {
            const response = await fetch(`${this.apiBaseUrl}/2fa/verify/setup`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.getAuthToken()}`
                },
                body: JSON.stringify({
                    setup_id: setupId,
                    totp_code: totpCode
                })
            });
            
            return response.ok;
        } catch (error) {
            console.error('2FA verification error:', error);
            return false;
        }
    }
    
    async authenticate(userId, totpCode) {
        try {
            const response = await fetch(`${this.apiBaseUrl}/2fa/authenticate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    user_id: userId,
                    totp_code: totpCode
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                this.setAuthToken(data.access_token);
                return {
                    success: true,
                    data: data
                };
            } else {
                return {
                    success: false,
                    error: data.error || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏'
                };
            }
        } catch (error) {
            console.error('2FA authentication error:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }
    
    getAuthToken() {
        return localStorage.getItem('access_token');
    }
    
    setAuthToken(token) {
        localStorage.setItem('access_token', token);
    }
    
    removeAuthToken() {
        localStorage.removeItem('access_token');
    }
}

// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
const twoFA = new TwoFAController('https://api.iskra.ai/v1');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA
async function setup2FAForUser(userId, email) {
    const result = await twoFA.setup2FA(userId);
    
    if (result.success) {
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR –∫–æ–¥–∞
        displayQRCode(result.data.qr_code_url);
        
        // –ü—Ä–æ—Å—å–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        const userCode = prompt('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –≤–∞—à–µ–≥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞:');
        
        const verified = await twoFA.verify2FASetup(result.data.setup_id, userCode);
        
        if (verified) {
            alert('2FA —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
            console.log('Backup –∫–æ–¥—ã:', result.data.backup_codes);
        } else {
            alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
        }
    } else {
        alert('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ 2FA: ' + result.error);
    }
}

// –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å 2FA
async function loginWith2FA(userId, totpCode) {
    const result = await twoFA.authenticate(userId, totpCode);
    
    if (result.success) {
        console.log('–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è');
        window.location.href = '/dashboard';
    } else {
        console.error('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:', result.error);
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
    }
}
```

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ê–∫—Ç–∏–≤–∞—Ü–∏—è 2FA —Å–∏—Å—Ç–µ–º—ã –≤ —ç–∫–æ—Å–∏—Å—Ç–µ–º–µ –ò—Å–∫—Ä–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä–æ–µ:

### –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏

1. **–ü–æ–≤—ã—à–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:** –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å TOTP
2. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ‚àÜDŒ©Œõ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã
3. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º:** GDPR, OWASP, ISO 27001
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ì–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∞—É–¥–∏—Ç–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:** –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç:** –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—é:** –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:** –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ staging:** –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
2. **–ü–æ—ç—Ç–∞–ø–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:** –í–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∑–∞—Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **–û–±—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—É—á–∞—é—â–∏—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
5. **–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ:** –ê–Ω–∞–ª–∏–∑ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ —Å–∏—Å—Ç–µ–º—ã

2FA —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –∏ –æ–±–µ—Å–ø–µ—á–∏—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞—â–∏—Ç—É —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –ò—Å–∫—Ä–∞.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 06.11.2025*  
*–í–µ—Ä—Å–∏—è: 1.0*  
*–ê–≤—Ç–æ—Ä: Claude Code Security Agent*